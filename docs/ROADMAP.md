# 从现在到伟大：一步一步实现的路线图

> 这份文档不是愿景，不是架构图，不是技术方案。
> 这是一份诚实的、可执行的路线图——从今天代码的真实状态出发，一步一步走向一个真正帮助人的产品。

---

## 零、先说实话：我们现在在哪

在谈"伟大"之前，必须诚实面对现实。

### 代码的真实状态

DecoPilot 有 ~23000 行代码，架构精良，模块齐全。深入审查后发现：

**核心连通逻辑已经存在，但有几个关键缺口。**

| 模块 | 代码存在 | 连通状态 | 真实情况 |
|------|---------|---------|---------|
| 记忆系统 (memory.py) | ✅ 2000行 | ✅ 已连通 | UserProfile 已通过 `_build_profile_summary()` 注入 prompt |
| 阶段感知 (stage_reasoning.py) | ✅ 981行 | ✅ 已连通 | 阶段检测→专家角色→system prompt 链路完整 |
| 工具系统 (tools.py) | ✅ 1542行 | ✅ 已连通 | 工具结果已通过 `_format_tool_results()` 注入 supplementary context |
| 决策树 (decision_tree.py) | ✅ 框架 | ⚠️ 缺数据 | 引擎和注入逻辑存在，但决策树数据稀疏 |
| 推理引擎 (reasoning.py) | ✅ 1178行 | ⚠️ 弱连通 | 推理类型被选择，但对 LLM 实际行为影响有限 |
| 知识库 (ChromaDB) | ✅ 5个集合 | ✅ 已填充 | 76 条知识（decoration_general 44 + c_end 13 + b_end 14 + smart_home 3 + merchant 2），覆盖瓷砖/地板/橱柜/卫浴/涂料/避坑/施工验收/补贴政策等核心场景 |
| 前端 (App.jsx) | ✅ ~1000行 | ✅ 工作 | UI 完整，思考过程/专家角色/结构化数据均可展示 |

之前的诊断说"零件齐全但引擎没连上轮子"——这不准确。更准确的说法是：

**引擎已经连上了轮子，但有三个关键缺口导致动力传不到路面。**

### 三个真正的缺口（已在里程碑一中修复）

1. **对话信息不回写**：用户说"我家120平，预算25万，日式风格，家里有小孩"——面积、预算、风格、家庭成员这些核心信息不会写入 UserProfile。`_update_user_context()` 只提取阶段和痛点，不提取这些关键字段。结果：profile 是空的，`_build_profile_summary()` 无数据可注入。

2. **没有避坑预警**：用户说了危险的话（"防水不做了"、"找熟人装修不用签合同"），系统不会主动警告。这是"问答机器"和"伙伴"的分水岭。

3. **profile 注入位置不够强**：用户画像在 supplementary context 中，而不是 system prompt 中。LLM 可能不够重视，导致回答不够个性化。

### 里程碑一的实际改动（已完成）

不是之前估计的"修改 1 个文件约 80 行"，实际改动更精准：

**Gap 1 — 对话信息提取回写**（`enhanced_agent.py:1122-1260`）
- 扩展 `_update_user_context()`，新增 `_extract_and_update_profile()` 方法
- 用正则从对话中提取面积、预算、风格偏好、家庭成员（老人/小孩/宠物）
- 只在 profile 对应字段为空时写入，避免覆盖已有数据
- 合理范围校验（面积 20-500㎡，预算 1万-500万）

**Gap 2 — 避坑预警**（`enhanced_agent.py:830-862`）
- 新增 `PITFALL_RULES` 类属性，10 条正则规则覆盖高频踩坑场景
- 全包合同、熟人装修、防水、水电走向、甲醛、验收、游击队、先施工后签合同等
- 新增 `_check_pitfall_warnings()` 方法
- 匹配到的预警注入 supplementary context，LLM 在回答中自然融入提醒

**Gap 3 — Profile 提升到 system prompt**（`enhanced_agent.py:893-902`）
- 用户画像从 supplementary context 提升到 system prompt
- 以 `## 当前用户信息` 的形式强制注入，附带指令"必须基于以下信息个性化回答，已知的不要再问"
- 同时在 `_prepare_context()` 中传入 `_user_message` 字段供避坑模块使用

### 愿景的真实状态

PRODUCT_VISION.md 描述了一个"用户智能体"——能替代笔记本、看板、日历、搜索引擎的智能伙伴。这个方向是对的，但需要在现有基础上一步步走过去，而不是跳过去。

**伟大不是一步到位的。伟大是每一步都扎实，每一步都交付真实价值。**

---

## 一、第一原则：先让一个用户说"这个东西真的帮到我了"

所有伟大的产品都始于一个真实的、具体的、让人感动的用户故事。不是"我们的架构很先进"，不是"我们的愿景很宏大"，而是——

> 一个正在装修的普通人，用了我们的产品之后，真的少花了冤枉钱，真的少走了弯路，真的觉得"有这个东西在，我心里踏实多了"。

这是唯一重要的事。在这件事发生之前，所有的架构、愿景、泛化计划都是空中楼阁。

---

## 二、路线图：五个里程碑

不按"周"排期，因为时间不是重点，质量才是。每个里程碑都有一个清晰的验证标准——不是"代码写完了"，而是"用户感受到了"。

---

### ✅ 里程碑一：让对话真正有用（已完成，已验证）

**验证标准：用户问一个装修问题，得到的回答比 ChatGPT 明显更好——更具体、更个性化、更有行动指导。**

#### 已完成的改动

1. **对话信息自动提取回写** — 用户说的面积、预算、风格、家庭成员信息现在会自动写入 UserProfile，下次对话直接使用
2. **避坑预警系统** — 10 条正则规则覆盖全包合同、防水、甲醛等高频踩坑场景，匹配时 LLM 自然融入提醒
3. **Profile 注入 system prompt** — 用户画像从 supplementary context 提升到 system prompt，确保 LLM 重视
4. **知识库已填充** — 76 条决策导向知识已导入 ChromaDB（decoration_general 44 + c_end 13 + b_end 14 + smart_home 3 + merchant 2）

#### 端到端验证结果（2026-02-22）

**Test 1 — Profile Extraction ✅**
- 输入："我家120平米，预算25万，喜欢日式风格，家里有个3岁的孩子"
- 结果：`house_area=120.0`, `budget_range=(200000, 300000)`, `preferred_styles=['日式']`, `has_children=True`
- 四个关键字段全部正确提取并写入 UserProfile

**Test 2 — Pitfall Warning ✅**
- 输入："防水不做了吧，省点钱"
- 结果：LLM 回答自然融入防水不能省的警告，结合用户具体情况（120㎡日式+有小孩）解释原因
- 阶段正确切换为"施工"，专家角色变为"工程监理"，情绪检测为"焦虑"

**Test 3 — Profile Personalization ✅**
- 输入："瓷砖怎么选？"（仅四个字，无任何上下文）
- 结果：LLM 基于之前提取的 profile 个性化回答——提到 120㎡、20-30万预算、日式风格、有小朋友，给出按空间分区的瓷砖推荐、日式风格材质建议、儿童安全防滑要求，附价格参考表
- 回答长度 3618 字，远超通用 AI 的泛泛回答

**额外验证通过的能力：**
- 阶段感知：Test 1 → "准备"阶段（装修规划师），Test 2 → "施工"阶段（工程监理）
- LLM 深度分析：关键词置信度不够时自动调用 LLM 分析
- 情绪检测：期待 / 焦虑 / 困惑 三种状态正确识别
- 知识库检索：瓷砖选购问题检索到相关知识条目并融入回答

---

### ✅ 里程碑二：让对话产生记忆（已完成，已验证）

**验证标准：用户第二次来对话时，智能体记得他上次说的事，并且用这些信息给出更好的回答。**

这是从"工具"到"伙伴"的第一步。一个记不住你说过什么的助手，永远只是工具。

#### 发现的问题与修复

里程碑一实现了信息提取，但发现跨会话记忆有四个关键缺口：

**Bug 1 — Profile 不会自动保存到磁盘**（`enhanced_agent.py:191`）
- `_update_user_context()` 设置 `_dirty = True`，但 `save_if_dirty()` 从未在请求流程中被调用
- `flush()` 只在 `shutdown()` 中调用——服务器非正常退出时所有 profile 更新丢失
- 修复：在每次请求处理完成后调用 `self.memory._profile_store.save_if_dirty()`

**Bug 2 — UserProfile 序列化不完整**（`memory.py:_save/_load`）
- `_save()` 不保存 `pain_points`、`decoration_journey`、`decision_factors`、`extra_info`（家庭成员、品牌偏好、决策记录）
- `_load()` 不恢复这些字段
- 修复：扩展 `_save()` 和 `_load()` 完整序列化/反序列化所有字段

**Bug 3 — chat.py 不从 JWT token 提取 user_id**（`chat.py:79-92`）
- `/stream` 端点不使用 `get_current_user` 依赖，`user_id` 来自可选的 `user_context` 字段
- 前端已正确传递 `authUser.id`，但后端不验证
- 修复：优先从 Authorization header 的 JWT token 提取 `user_id`，其次从 `user_context` 获取

**新功能 — 品牌偏好和决策记录提取**（`enhanced_agent.py:_extract_and_update_profile`）
- 新增 37 个品牌关键词覆盖瓷砖/地板/全屋定制/卫浴/厨电/涂料/开关
- 品牌情感分析（好评/差评/中性），基于上下文窗口匹配
- 决策记录提取（"地板选了大自然"、"设计师定了"等）
- 品牌印象和已做决策注入 `_build_profile_summary()`，LLM 回答时自然引用

#### 端到端验证结果（2026-02-23）

**Test 1 — Profile 持久化 ✅**
- 创建 profile → 设置字段 → `save_if_dirty()` → 写入 JSON
- 所有字段正确序列化：house_area、budget_range、preferred_styles、pain_points、extra_info（family_members、brand_mentions、decisions）

**Test 2 — 跨会话加载 ✅**
- 新建 `UserProfileStore` 实例（模拟服务器重启）→ 从 JSON 加载
- 所有字段正确反序列化，包括 decoration_journey、decision_factors、extra_info

**Test 3 — 品牌和决策提取 ✅**
- 输入："邻居说东鹏瓷砖不错，我也去看了马可波罗"
- 结果：东鹏(positive)、马可波罗(positive) 正确提取
- 输入："地板选了大自然的三层实木"
- 结果：决策记录正确提取

**Test 4 — Profile Summary 注入 ✅**
- Summary 包含品牌印象和已做决策
- 输出示例：`品牌印象：东鹏(好评)、马可波罗(好评)、大自然(好评)` + `已做决策：地板选了大自然的三层实木（已决定的不要再推荐替代方案）`

**Test 5 — 完整跨会话端到端 ✅**
- Session 1：用户说"我家120平米，预算25万，喜欢日式风格，家里有个3岁的孩子。邻居说东鹏瓷砖不错，地板我已经选了大自然的三层实木。"
- Profile 提取：house_area=120.0, budget_range=(200000,300000), preferred_styles=['日式'], has_children=True, brands=['东鹏','大自然'], decisions=['地板选了大自然']
- Profile 持久化到磁盘 ✅
- Session 2（新 agent 实例，模拟重启）：用户说"瓷砖怎么选？"
- Profile 从磁盘正确加载 ✅
- LLM 回答个性化：提到 120㎡、日式、孩子、东鹏、大自然 ✅
- 回答长度 1303 字，完全基于用户具体情况

#### 架构改进（2026-02-23）

在里程碑二的基础上，对记忆系统进行了深层架构改进：

**改进 1 — Profile 存储迁移到 SQLite**（`memory.py`）
- 用 `SQLiteProfileStore` 替换了 `UserProfileStore`（JSON 文件）
- 每个 profile 独立存储为一行（`user_id` 主键 + `profile_data` JSON 列）
- WAL 模式并发读写，原子写入
- `_dirty_users` 集合追踪变更用户，`save_if_dirty()` 只写变更行
- 首次启动自动从 `user_profiles.json` 迁移数据，旧文件备份为 `.migrated`
- 实际运行：132 个现有 profile 自动迁移成功

**改进 2 — 长期记忆管道打通**（`enhanced_agent.py` + `memory.py`）
- `_update_memory()` 新增：将高价值对话轮次写入 `SQLiteMemoryStore`（`memory.db`）
- 新增 `_assess_conversation_importance()` 评估对话重要性（0-1分）
  - 包含数字/决策/品牌/需求的对话得高分，闲聊得低分
  - 只有 importance >= 0.5 的对话才写入长期记忆
- `_build_prompt_parts()` 新增：将长期记忆注入 supplementary context
- 修复 `search_long_term()`：使用 `SQLiteMemoryStore.search_by_user()` 替代 `.store.values()` 遍历

**改进 3 — 记忆维护系统激活**（`enhanced_agent.py` + `memory.py`）
- 每 50 次请求自动触发 `run_maintenance()`
- 修复 `apply_forgetting()`、`merge_similar_memories()`、`run_maintenance()` 中的 `.store.values()` 调用
- 遗忘曲线和记忆合并现在真正工作

**修复的死代码：**
- `search_long_term()` — 之前用 `.store.values()` 遍历，SQLite 后端会崩溃
- `apply_forgetting()` — 同上
- `merge_similar_memories()` — 同上
- `run_maintenance()` — 同上 + 从未被调用
- `memory.db` 的 `memories` 表 — 之前永远是空的，现在会写入高价值对话

---

### ✅ 里程碑三：让智能体主动帮忙（已完成，已验证）

**验证标准：用户说了一句话，智能体不仅回答了问题，还主动提醒了用户没想到的事。**

这是"问答机器"和"伙伴"的分水岭。

#### 现状评估（修正）

之前认为避坑预警是里程碑三的内容。实际上里程碑一已经实现了 10 条避坑规则。阶段转换提醒也已经在 `stage_reasoning.py` 的 `C_END_STAGE_TRANSITIONS` 中实现，并通过 `_build_prompt_parts()` 注入。

里程碑三真正做的是：
1. **扩展避坑规则** — 从 10 条扩展到 25 条，覆盖更多场景
2. **话题依赖图（Topic Dependency Graph）** — 用户聊到某个话题时，自动检查前置依赖是否完成，缺什么提醒什么
3. **阶段 checklist 兜底** — 话题依赖图未触发时，按当前阶段提醒最重要的 1 个待办项
4. **决策树数据已完备** — 瓷砖、地板、全屋预算、施工验收 4 棵决策树数据齐全（里程碑二之前已完成）

#### 已完成的改动（2026-02-24）

**改动 1 — 避坑规则扩展**（`enhanced_agent.py:887-948`）
- 从 10 条扩展到 25 条，新增 15 条规则
- 新增分类覆盖：
  - 合同与施工队：口头承诺无效、全款支付风险
  - 水电安全：老房水电必须重做、电线规格要求
  - 材料选择：地板怕水、瓷砖必须留缝、门窗更换、插座数量
  - 环保健康：板材环保等级
  - 验收监理：隐蔽工程拍照留存
  - 预算增项：增项上限、预算不够优先硬装、设计师价值
  - 工期流程：赶工期风险、装修顺序错误

**改动 2 — 话题依赖图 + 主动引导**（`enhanced_agent.py:956-1157`）

核心设计理念——冰山模型：平时不啰嗦，但用户聊到具体话题时，能从话里听出你可能忽略了什么。

- 新增 `TOPIC_DEPENDENCY_GRAPH` 类属性：12 条话题-依赖规则
  - 用户聊瓷砖 → 检查预算、风格、防水是否已确认
  - 用户聊橱柜 → 检查水电点位是否已确认
  - 用户聊开工 → 检查预算、设计方案是否已确认
  - 用户聊入住 → 检查验收、甲醛检测是否已完成
  - 等 12 个场景，覆盖装修全流程的关键依赖关系
- 新增 `STAGE_DECISION_CHECKLIST` 作为兜底：4 个阶段 × 3-4 个关键决策项
- 重构 `_build_proactive_guidance(profile, stage, user_message)` 方法：
  - 第一优先级：话题依赖图——用户聊什么就检查什么的前置条件，精准且自然
  - 第二优先级：阶段 checklist——兜底，只提 1 个最重要的待办项，保持克制
  - 检查两种条件：`profile.字段`（有没有数据）和 `decision:关键词`（有没有决策记录）
  - 已满足的条件自动跳过，只提醒真正缺失的
  - 最多 2 条提醒，避免信息过载
- 在 `_build_prompt_parts()` 中集成：避坑预警之后、阶段转换引导之前注入

#### 端到端验证结果（2026-02-24）

**Test 1 — 空 profile + 聊瓷砖 ✅**
- 输入："瓷砖怎么选"（profile 无预算、无风格、无防水记录）
- 结果：触发 3 条提醒（预算、风格、防水），注入前 2 条
- 验证：智能体不只回答瓷砖问题，还自然提醒"先定预算和风格"

**Test 2 — 有预算+风格 profile + 聊瓷砖 ✅**
- 输入："瓷砖怎么选"（profile 有预算 20-30万、风格日式，但无防水记录）
- 结果：只触发 1 条提醒（防水），预算和风格已满足自动跳过
- 验证：智能体只提醒真正缺失的前置条件

**Test 3 — 完整 profile + 聊瓷砖 ✅**
- 输入："瓷砖怎么选"（profile 有预算+风格，决策记录有"防水闭水试验通过"）
- 结果：0 条提醒，所有前置条件已满足
- 验证：不啰嗦，该安静时安静

**Test 4 — 闲聊不触发 ✅**
- 输入："你好" / "今天天气不错"
- 结果：0 条提醒
- 验证：冰山模型——平时水面下，不该出来时不出来

---

### ✅ 里程碑四：让数据为用户工作（已完成，已验证）

**验证标准：用户能看到自己的"装修档案"，觉得"这个东西帮我把装修这件事理清楚了"。**

这是 PRODUCT_VISION.md 中"User Context File"概念的最小可用版本。

#### 已完成的改动（2026-02-24）

**改动 1 — 后端档案 API**（`backend/api/routes/profile.py`，新增文件）
- `GET /api/v1/profile/me` — 返回当前用户的完整装修档案
- 从 MemoryManager 获取 UserProfile，序列化为前端可用的 JSON
- 包含：房屋信息、预算、风格、家庭成员、已做决策、品牌印象、痛点、兴趣、装修旅程、对话统计
- 在 `server.py` 中注册路由

**改动 2 — 前端档案页面**（`frontend/src/components/ProfilePage.jsx`，新增文件）
- 完整的装修档案可视化页面，展示智能体从对话中记住的所有信息
- 分区展示：装修阶段、房屋信息、家庭情况、已做决策、品牌印象、关注问题、近期关注、对话统计
- 空状态引导：档案为空时提示用户"和智能体聊聊你的装修情况"
- 装修旅程时间线：展示阶段转换历史
- 响应式设计，与现有 UI 风格一致

**改动 3 — 侧边栏集成**（`frontend/src/App.jsx`）
- 新增 `currentView` 状态（'chat' | 'profile'）
- 侧边栏底部新增"我的档案"按钮（FileText 图标），点击切换视图
- 主内容区条件渲染：profile 视图显示 ProfilePage，chat 视图显示聊天界面
- 档案按钮高亮状态跟随当前视图

#### 构建验证（2026-02-24）

- `vite build` ✅ — 前端构建成功，无错误
- `python ast.parse` ✅ — 后端 profile.py、server.py 语法正确
- 路由注册 ✅ — profile_router 在 server.py 中正确注册

---

### 里程碑五：让产品自己说话

**验证标准：用户主动把产品推荐给正在装修的朋友。**

到这一步，产品已经具备了核心价值：
- 对话质量超过通用 AI（因为有用户上下文和领域知识）
- 有记忆（记得你说过的每一件事）
- 会主动帮忙（避坑提醒、决策引导、阶段提醒）
- 有可见的价值沉淀（装修档案）

这时候才是考虑扩展的时候：

**可以开始做的事：**
- 深度研究报告（Phase 3 of DEEP_RESEARCH_UPGRADE_PLAN）
- 更完整的看板功能（进度追踪、时间线、预算消耗）
- 主动提醒系统（基于项目节点的推送）
- B端价值闭环（需求洞察聚合）

**可以开始想的事：**
- 场景泛化（买房、婚礼、育儿...）
- User Agent 框架抽象
- 多场景共享用户档案

但这些都是里程碑五之后的事。在此之前，专注于让装修这一个场景做到极致。

---

## 三、关于"伟大"的思考

### 伟大不是功能多

DecoPilot 的代码量已经很大了。23000 行代码，9 个工具，6 种推理类型，5 层记忆。但用户感受到的价值取决于这些模块是否真正协同工作。

里程碑一的改动只有 ~120 行，但它打通了"用户说话→信息沉淀→个性化回答"的完整链路。这比新增 1000 行独立功能更有价值。

### 伟大不是架构美

DecoPilot 的架构已经很好了——而且比之前诊断的要好得多。`_build_prompt_parts()` 已经是一个设计良好的集成点，把 profile、tools、stage、decision tree、knowledge 统一注入。

**架构的价值不在于它有多复杂，而在于数据是否真正流过它。**

### 伟大是每一步都交付真实价值

```
里程碑一：用户说"这个回答比 ChatGPT 好"          → 有用       ✅ 已完成
里程碑二：用户说"它记得我上次说的"                → 有记忆     ✅ 已完成
里程碑三：用户说"它提醒了我没想到的事"            → 有主动性   ✅ 已完成
里程碑四：用户说"它帮我把装修理清楚了"            → 有价值沉淀 ✅ 已完成
里程碑五：用户说"你也在装修？用这个"              → 有口碑
```

每一步都是用户可感知的价值提升。不是"我们升级了架构"，而是"用户的体验变好了"。

### 伟大是解决真实的人的真实问题

DEEP_RESEARCH_UPGRADE_PLAN 里有一句话说得很好：

> 装修是绝大多数普通人一生中最大的非金融消费决策。

一个普通人，第一次装修，面对 100+ 个他完全不懂的决策，每个决策都可能浪费几千到几万块钱。他焦虑、迷茫、不知道该信谁。

如果我们的产品能让这个人在装修过程中少一点焦虑、少花一点冤枉钱、少走一点弯路——这就是真正的价值。这就是伟大的起点。

不是因为我们用了多先进的技术，不是因为我们的架构有多优雅，而是因为我们真的帮到了一个具体的人。

---

> 伟大不是一个时刻，是一个过程。
> 不是某天突然"我们做出了伟大的产品"，而是每一天都在让产品对用户更有价值一点点。
> 第一步已经迈出去了。继续走。
